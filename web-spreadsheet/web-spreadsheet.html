<html>
<head>
  <!-- Polyfills only needed for Firefox and Edge. -->
  <script src="https://unpkg.com/@webcomponents/webcomponentsjs@latest/webcomponents-loader.js"></script>
</head>
<body>
  <!-- Works only on browsers that support Javascript modules like
       Chrome, Safari, Firefox 60, Edge 17 -->
  
<!--   <script>
    const expressionParser () => {
      var expressionependencies = [];
      var ast;
      
      const compileExpression (expression) => {  
        ast = buildAst(expression); 
      };
      
      const addDependencies (ast) => {
        
      };
      
      const buildAst = (expression) => {
        retrun {};
      };
      
      const evaluate(params, ast) => {
        
      };
      
      return {
        parse: (expression) => {
          
        },
        evaluate: (params) => {
          return evaluate(params, ast)
        }
      }
    }
  </script> -->
  <script type="module">
    import {LitElement, html, css} from 'https://unpkg.com/lit-element/lit-element.js?module';
    
    class MyElement extends LitElement {

      static get properties() {
        return {
          mood: {type: String }
        }
      }
      
      static get styles() {
        return css`.mood { color: green; }`;
      }

      render() {
        return html`Web Components are <span class="mood">${this.mood}</span>!`;
      }
      
    }

    customElements.define('my-element', MyElement);
  </script>
  
  <script type="module">
    import {LitElement, html, css} from 'https://unpkg.com/lit-element/lit-element.js?module';
    
    class SpreadSheetInput extends LitElement {

      static get properties() {
        return {
          mood: {type: String },
          formula: { 
            type: Function 
          },
          value: {
            type: Number,
          },
          onChange: {
            type: Function,
          },
        }
      }     
      
      render() {
        return html`<input type="number" value=${this.value} @change=${this.onChange} ></input>`;
      }
      
    }

    customElements.define('spread-sheet-input', SpreadSheetInput);
  </script>
  
  <script type="module">
    import {LitElement, html, css} from 'https://unpkg.com/lit-element/lit-element.js?module';
    
    class SpreadSheetGrid extends LitElement {
      constructor() {
        super();
        
        this.subscribersMap = [];
      
        const addSubscription = (subscribeToX, subscribeToY, observerX, observerY) =>  {
          //this.subscribersMap[subscribeToX][subscribeToY] = ;
          if(!this.subscribersMap[subscribeToX]) {
            this.subscribersMap[subscribeToX] = [];
          }
          if(!this.subscribersMap[subscribeToX][subscribeToY]) {
            this.subscribersMap[subscribeToX][subscribeToY] = [];
          }
          this.subscribersMap.length 
          for(let i=0; i<this.subscribersMap[subscribeToX][subscribeToY].length; i++) {
            const [ existingSubscriberX, existingSubscriberY] = this.subscribersMap[subscribeToX][subscribeToY][i];
            if(existingSubscriberX == observerX && observerY == existingSubscriberY) {
              // observer already added
              return;
            }
            
          }
          this.subscribersMap[subscribeToX][subscribeToY].push([observerX, observerY]);
        }
        
        const addFormula = (x, y, formula) => {
          this.cells[x][y].formula = formula;
          formula.formulaDependencies.forEach(dep => {
            addSubscription(dep[0], dep[1], x, y);
          });
          this.cells[x][y].value = this.cells[x][y].formula.formulaExpression(this.cells);
        }
        
        const updateValue = (x,y, value) => {
          
        };
        
        this.cells = [
          [
            { value: 1.05, formula: null },
            { value: 2.02, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
          ],
          [
            { value: 234.32, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { 
             value: null, 
             formula: null,
            },
          ],
          [
            { value: 234.32, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
          ],
          [
            { value: 234.32, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
          ],
          [
            { value: 234.32, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            
          ],
          [
            { value: 234.32, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
          ],
          [
            { value: 234.32, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
          ],
          [
            { value: 234.32, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
          ],
          [
            { value: 234.32, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
          ],
          [
            { value: 234.32, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
          ],
          [
            { value: 234.32, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
          ],
          [
            { value: 234.32, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
            { value: 324.83, formula: null },
          ],
        ];
        
        addFormula(1, 5, {
          formulaExpression: cells => 
            cells[0][1].value + cells[0][2].value,
          formulaDependencies: [ [0,1], [0,2] ],
        });
        
        addFormula(2, 4, {
          formulaExpression: cells => 
            cells[0][1].value + cells[0][2].value + cells[4][2].value,
          formulaDependencies: [ [0,1], [0,2], [4,2] ],
        });
        
        addFormula(5,1, {
          formulaExpression: cells => 
            cells[2][4].value + cells[0][2].value + cells[4][2].value,
          formulaDependencies: [ [2,4], [0,2], [4,2] ],
        });
      }
     
      static get properties() {
        return {
          formula: { 
            type: Function 
          },
          value: {
            type: Number,
          },
        }
      }     
     
      render() {
        return html`<table>
          ${this.cells.map((row, index) => html`<tr>${this.renderRow(row, index)}</tr>`)}
        </table>`;
      }
      
//       reavaluate(cells) {
//         for(let i=0; i<cells.length; i++) {
//         }
//       }
      
//       evaluateFormula(cells, cellToEvaluate) {
//       }
      
      
      notifyValueChange(row, column, value) {
        console.log(`notifyValuechange ${row} ${column} ${value}`);
        //syncup
        
        this.cells[row][column].value = parseFloat(value);
        if(this.subscribersMap[row]) {
          if(this.subscribersMap[row][column]) {
            console.log('found obswervers');
            this.subscribersMap[row][column].forEach( observer => {
              const [observerRow, observerColumn] = observer;
              console.log(`updating ${observerRow} ${observerColumn}`)
              this.updateObserverValue(observerRow, observerColumn);
            });
          }
        }
      }
      
      syncDown(row, column, value) {
        const elementToUpdate = this.shadowRoot.getElementById(`cell_${row}_${column}`);
        console.log(`sync down row=${row} column=${column}`, elementToUpdate);
        elementToUpdate.value = value;
      }
      
      updateObserverValue(observerRow, observerColumn) {
        const cell = this.cells[observerRow][observerColumn];
        const { formula } = cell;
        console.log('cell: ', cell);
        console.log(`updateObserverValue formula`, formula, this.cells);
        const value = formula.formulaExpression(this.cells);
        console.log(`updateObserverValue value=${value}`);
        cell.value = value;
        this.syncDown(observerRow, observerColumn, value);
      }
      
      renderRow(row, rowIndex) {
        return html`
         ${row.map( (cell, index) => html`
         <td>
          <spread-sheet-input id=${`cell_${rowIndex}_${index}`} .value=${cell.value} .onChange=${(e) => { 
            console.log(`changed = ${e.target.value}`);
            this.notifyValueChange(rowIndex, index, e.target.value); 
          }}>
          </spread-sheet-input>
         </td>`)}
        `;
      }
    }

    customElements.define('spread-sheet-grid', SpreadSheetGrid);
  </script>
  
  <my-element mood="great"></my-element>
  <spread-sheet-input value="41234"></spread-sheet-input>
  <br/>
  <spread-sheet-grid></spread-sheet-grid>
  
</body>
</html>
